const Discord= require ("./discord.js");
const mysql = require('./mysql');
const config=require("./config.json")

class Mobile_suit{

  constructor(id,model,lvl,hp,defense,strength,speed,manned) {
    //general constructor with database connection
    this.con= mysql.createConnection({
      host: 'localhost',
      user: 'root',
      password: config.mysqlpass,//interchangable
      database: config.mysqlbase,//interchangable
      insecureAuth: true
    });

    this.id=id;
    this.model=model;
    this.lvl=lvl;
    this.hp=hp;
    this.defense=defense;
    this.strength =strength;
    this.speed=speed;
    this.manned=manned;
  }

  ////////////////////////////////////////
  //the following function is dedicated //
  //to adding mobile suit specs to the  //
  //mobile_suits database               //
  ////////////////////////////////////////
  add_MobileSuit(){
    //this.con.connect((err)=>{
      var exiting="UPDATE mobile_suits SET Manned=FALSE WHERE ID='"+this.id+"' AND Manned=TRUE";
      var row="INSERT INTO mobile_suits"+
      "(ID, Model, Lvl, Hp, Defense, Strength, Speed, Manned)"+
      "VALUES('"+this.id+"',"+"'"+this.model+
             "',"+this.lvl+","+this.hp+","+this.defense+
             ","+this.strength+","+this.speed+","+this.manned+")";

      try{
        this.con.query(exiting,(err,results)=>{
          if (err) throw err;
          console.log("Suits exited")
        })
        this.con.query(row, (err, results)=>{
          if (err) throw err;
          console.log("Row inserted")
        })
      }
      catch(e){
        console.log(err);
      }
    //})
  }

  ///////////////////////////////////////
  //the following function is untested //
  //but should work                    //
  ///////////////////////////////////////
  change_model(id,model_1,model_2){
    this.con.connect((err)=>{
      var row="INSERT INTO mobile_suits(Model)VALUES('"+model_2+"') WHERE Model='"+model_1+"'"

      this.con.query(row, (err, result)=>{
        if (err) throw err;
        else {
          console.log("\nmodel changed for id: "+id+
          "\n                            Model: "+model_1);
        }
      })
    })
  }

  //////////////////////////////////
  // changes BOOL flag for manned //
  // collumn for speciific model  //
  //////////////////////////////////
  pilot_suit(id,model){
    //this.con.connect((err)=>{
      var pilot="UPDATE mobile_suits SET Manned=TRUE WHERE id='"+id+"'AND model='"+model+"'"
      var exiting="UPDATE mobile_suits SET Manned=FALSE WHERE id='"+id+"' AND Manned=TRUE"

      try{
        this.con.query(exiting,(err,results)=>{
          if(err) throw err;
          else console.log("Values in Manned changed to FALSE");
        });
        this.con.query(pilot,(err, results)=>{
          if (err) throw err;
          else console.log("Selected value in Manned changed to TRUE");
        });
      }
      catch(e){
        console.log(err);
      }
    //});
  }

  ////////////////////////////////////////////////////////////////////
  //the follwing function needs to be repaired so that it returns a //
  //string with similar selection resuts to those that would be     //
  //to the console.                                                 //
  ////////////////////////////////////////////////////////////////////
  //successfully called fucntion
  //but it is giving me an ugly Object to JSON string
  //in a format that is straining to read
  //see command file showMeMySuits for refference
  //in the primary bot file sisodil.js
  search_ALLMobileSuits(id,callback){
    //this.con.connect((err)=>{
      var select="SELECT * FROM mobile_suits WHERE id='"+id+"'"

      try{
        this.con.query(select,(err, results)=>{
          if (err) callback(err,null);
          else {
            callback(null, JSON.stringify(results));
            console.log("results: "+results);

          };
        })
      }
      catch(e){
        console.log(err);
      };
    //})
  }

  //////////////////////////////////////////////////
  //
  /////////////////////////////////////////////////
  initiate_combat(id1,id2,bot,callback){
    //this.con.connect((err)=>{

      var player_1="SELECT * FROM mobile_suits WHERE id='"+id1+"' AND Manned=TRUE"
      var player_2="SELECT * FROM mobile_suits WHERE id='"+id2+"' AND Manned=TRUE"

      var suit_1;
      var suit_2;
      var suits=[];


      try{
        this.con.query(player_1,(err,results)=>{
          if(err) callback(err,null);
          else{
            //parse results into  json string
            var str=JSON.stringify(results);
            //slice uneccessary brackets at beginning and end of string
            str=str.slice(1,-1);
            //parse new string into JSON object
            suit_1=JSON.parse(str);
            //now we have access to individual variables
            suits[0]=suit_1;
          }
        })//end of query
      }//end of try
      catch(e){
        console.log(err);
      }
      try{
        this.con.query(player_2,(err,results)=>{
            if(err) callback(err,null);
            else{

              var str=JSON.stringify(results);
              str=str.slice(1,-1);
              suit_2=JSON.parse(str);

              suits[1]=suit_2;
              callback(null,suits);
            }
        })//end of query
      }//end of try
      catch(e){
        console.log(err);
      }
      //this.con.end();
    //})
  }
}
module.exports=Mobile_suit;
